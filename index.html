<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Matrices Dashboard</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
h1 { text-align: center; color: #58a6ff; margin-bottom: 6px; font-size: 22px; }
.subtitle { text-align: center; color: #484f58; font-size: 12px; margin-bottom: 16px; }

/* Tabs */
.tabs { display: flex; justify-content: center; gap: 4px; margin-bottom: 20px; }
.tab { padding: 8px 20px; border-radius: 8px 8px 0 0; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid #30363d; border-bottom: none; background: #161b22; color: #8b949e; transition: all 0.15s; }
.tab:hover { color: #c9d1d9; background: #1c2128; }
.tab.active { background: #0d1117; color: #e6edf3; border-color: #58a6ff; border-bottom: 2px solid #0d1117; position: relative; top: 1px; }
.tab .tab-count { background: #30363d; color: #8b949e; font-size: 10px; padding: 1px 6px; border-radius: 8px; margin-left: 6px; }
.tab.active .tab-count { background: #1f6feb; color: #fff; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.tab-bar-line { border-bottom: 1px solid #30363d; margin-top: -1px; margin-bottom: 20px; }

/* Grid */
.grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; max-width: 1300px; margin: 0 auto; }
.grid-2 { grid-template-columns: 1fr 1fr; }
.col { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 16px; }
.col-header { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid #30363d; }
.col-header h2 { font-size: 15px; font-weight: 600; }
.col-header .count { background: #30363d; color: #8b949e; font-size: 11px; padding: 2px 8px; border-radius: 10px; }

/* Project groups */
.project-group { margin-bottom: 14px; }
.project-group:last-child { margin-bottom: 0; }
.project-divider { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #21262d; }
.project-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.project-name { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

/* Cards */
.badge { display: inline-block; font-size: 10px; padding: 2px 7px; border-radius: 8px; font-weight: 600; margin-left: 6px; }
.badge-draft { background: #1f2d1f; color: #3fb950; }
.badge-brief { background: #1c2333; color: #58a6ff; }
.badge-urgent { background: #3d1f1f; color: #f85149; }
.badge-waiting { background: #2d2a1f; color: #d29922; }
.badge-done { background: #1f2d1f; color: #3fb950; }
.badge-blocked { background: #2d2a1f; color: #d29922; }
.card { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; transition: border-color 0.15s; cursor: default; }
.card:last-child { margin-bottom: 0; }
.card:hover { border-color: #58a6ff; }
.card.clickable { cursor: pointer; }
.card.clickable:hover { border-color: #58a6ff; background: #161b22; }
.card.clickable .card-title { color: #58a6ff; }
.card-title { font-size: 13px; font-weight: 600; color: #e6edf3; margin-bottom: 3px; }
.card-desc { font-size: 11px; color: #8b949e; line-height: 1.4; }
.card-desc .inline-link { color: #58a6ff; cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
.card-desc .inline-link:hover { text-decoration-style: solid; }
.card-meta { font-size: 10px; color: #484f58; margin-top: 4px; }
.empty { color: #484f58; font-size: 12px; font-style: italic; text-align: center; padding: 20px 0; }
.refresh-note { text-align: center; color: #30363d; font-size: 11px; margin-top: 16px; }
.completed-card { opacity: 0.7; }
.completed-card .card-title { text-decoration: line-through; color: #8b949e; }
.completed-card.clickable .card-title { color: #58a6ff; }

/* View icon for clickable cards */
.view-icon { float: right; font-size: 11px; color: #484f58; margin-left: 8px; }
.card.clickable:hover .view-icon { color: #58a6ff; }

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 24px;
}
.modal-overlay.visible { display: flex; }
.modal {
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 12px;
  width: 100%;
  max-width: 860px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 16px 64px rgba(0,0,0,0.5);
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #30363d;
  flex-shrink: 0;
}
.modal-title {
  font-size: 15px;
  font-weight: 600;
  color: #e6edf3;
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-title .file-type {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 8px;
  font-weight: 600;
  background: #1c2333;
  color: #58a6ff;
}
.modal-close {
  background: none;
  border: 1px solid #30363d;
  color: #8b949e;
  font-size: 18px;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}
.modal-close:hover { background: #21262d; color: #f85149; border-color: #f85149; }
.modal-body {
  overflow-y: auto;
  padding: 24px;
  flex: 1;
  min-height: 0;
}

/* Markdown rendered content */
.modal-body .md-content {
  font-size: 14px;
  line-height: 1.7;
  color: #c9d1d9;
}
.md-content h1 { font-size: 24px; color: #e6edf3; margin: 0 0 12px; padding-bottom: 8px; border-bottom: 1px solid #30363d; }
.md-content h2 { font-size: 20px; color: #e6edf3; margin: 24px 0 8px; padding-bottom: 6px; border-bottom: 1px solid #21262d; }
.md-content h3 { font-size: 16px; color: #e6edf3; margin: 20px 0 6px; }
.md-content h4 { font-size: 14px; color: #e6edf3; margin: 16px 0 4px; }
.md-content p { margin: 8px 0; }
.md-content ul, .md-content ol { margin: 8px 0; padding-left: 24px; }
.md-content li { margin-bottom: 4px; }
.md-content a { color: #58a6ff; }
.md-content code { background: #21262d; padding: 2px 6px; border-radius: 4px; font-size: 13px; color: #e6edf3; }
.md-content pre { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 14px; overflow-x: auto; margin: 12px 0; }
.md-content pre code { background: none; padding: 0; }
.md-content blockquote { border-left: 3px solid #58a6ff; padding: 4px 16px; margin: 12px 0; color: #8b949e; background: #0d1117; border-radius: 0 6px 6px 0; }
.md-content table { width: 100%; border-collapse: collapse; margin: 12px 0; }
.md-content th { background: #21262d; padding: 8px 12px; text-align: left; border: 1px solid #30363d; font-size: 12px; color: #e6edf3; }
.md-content td { padding: 8px 12px; border: 1px solid #30363d; font-size: 13px; }
.md-content tr:nth-child(even) { background: #0d1117; }
.md-content hr { border: none; border-top: 1px solid #30363d; margin: 16px 0; }
.md-content strong { color: #e6edf3; }
.md-content em { color: #8b949e; }

/* HTML iframe content */
.modal-body iframe {
  width: 100%;
  border: none;
  border-radius: 8px;
  background: #fff;
  min-height: 600px;
}

/* Loading state */
.modal-loading {
  text-align: center;
  padding: 40px;
  color: #8b949e;
  font-size: 13px;
}
.modal-loading::before {
  content: '‚è≥';
  display: block;
  font-size: 24px;
  margin-bottom: 8px;
}
.modal-error {
  text-align: center;
  padding: 40px;
  color: #f85149;
  font-size: 13px;
}

/* ===== BACKLOG ===== */
.backlog-tag { display: inline-block; font-size: 10px; padding: 1px 6px; border-radius: 6px; background: #21262d; color: #8b949e; margin-right: 4px; margin-top: 4px; }

/* ===== CALENDAR ===== */
.cal-container { max-width: 900px; margin: 0 auto; }
.cal-week { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 16px; margin-bottom: 14px; }
.cal-week:last-child { margin-bottom: 0; }
.cal-week-header { font-size: 12px; font-weight: 700; color: #58a6ff; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #30363d; }
.cal-entry { display: flex; align-items: center; gap: 10px; padding: 7px 0; border-bottom: 1px solid #21262d; }
.cal-entry:last-child { border-bottom: none; }
.cal-date-col { min-width: 70px; font-size: 12px; font-weight: 600; color: #e6edf3; }
.cal-day-col { min-width: 32px; font-size: 11px; color: #484f58; }
.cal-time-col { min-width: 64px; font-size: 11px; color: #d29922; font-weight: 500; font-variant-numeric: tabular-nums; }
.cal-title-col { font-size: 13px; color: #c9d1d9; flex: 1; }
.cal-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.cal-entry.span-entry { background: #1c2128; margin: 4px -8px; padding: 7px 8px; border-radius: 6px; border-bottom: none; }
.cal-entry.span-entry .cal-date-col { color: #d29922; }
.cal-entry.today-entry { background: #1a2233; margin: 0 -8px; padding: 7px 8px; border-radius: 6px; }
.cal-entry.today-entry .cal-date-col { color: #58a6ff; }
</style>
</head>
<body>

<h1>üî≤ Matrices Dashboard</h1>
<p class="subtitle">Last updated: <span id="timestamp"></span> ¬∑ Auto-refreshes every 30s</p>

<div class="tabs">
  <div class="tab active" data-tab="today">üìç Today</div>
  <div class="tab" data-tab="active">‚ö° Active <span class="tab-count" id="active-total"></span></div>
  <div class="tab" data-tab="waiting">‚è∏Ô∏è Waiting on Others <span class="tab-count" id="waiting-total"></span></div>
  <div class="tab" data-tab="completed">‚úÖ Completed <span class="tab-count" id="completed-total"></span></div>
  <div class="tab" data-tab="issues">üîì Open Issues <span class="tab-count" id="issues-total"></span></div>
  <div class="tab" data-tab="ideas">üí° Ideas <span class="tab-count" id="ideas-total"></span></div>
  <div class="tab" data-tab="backlog">üìã Backlog <span class="tab-count" id="backlog-total"></span></div>
  <div class="tab" data-tab="calendar">üìÖ Calendar <span class="tab-count" id="calendar-total"></span></div>
  <div class="tab" data-tab="transcripts">üìù Transcripts <span class="tab-count" id="transcripts-total"></span></div>
</div>
<div class="tab-bar-line"></div>

<!-- TODAY TAB -->
<div class="tab-content active" id="tab-today">
<div class="cal-container" style="max-width:700px;">
  <div id="today-header" style="text-align:center; margin-bottom:20px;">
    <div style="font-size:28px; font-weight:700; color:#e6edf3;" id="today-date-display"></div>
    <div style="font-size:12px; color:#484f58; margin-top:4px;">Daily briefing ‚Äî links & tasks for today</div>
  </div>
  <div id="today-list"></div>
  <div id="today-done-section" style="margin-top:20px;">
    <div style="font-size:11px; color:#484f58; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; padding-bottom:6px; border-bottom:1px solid #21262d;">‚úÖ Done</div>
    <div id="today-done-list"></div>
  </div>
  <div style="text-align:center; margin-top:24px; font-size:11px; color:#30363d;">Updated by Matrices ¬∑ Edit today-data.json to change</div>
</div>
</div>

<!-- ACTIVE TAB -->
<div class="tab-content" id="tab-active">
<div class="grid">
<div class="col">
<div class="col-header"><h2>üìÑ Files to Review</h2><span class="count" id="files-count"></span></div>
<div id="files-list"></div>
</div>
<div class="col">
<div class="col-header"><h2>‚ö° Action Required</h2><span class="count" id="tasks-count"></span></div>
<div id="tasks-list"></div>
</div>
<div class="col">
<div class="col-header"><h2>üìå Upcoming</h2><span class="count" id="upcoming-count"></span></div>
<div id="upcoming-list"></div>
</div>
</div>
</div>

<!-- WAITING TAB -->
<div class="tab-content" id="tab-waiting">
<div class="grid grid-2" style="max-width:900px;">
<div class="col">
<div class="col-header"><h2>‚è∏Ô∏è Waiting on Others</h2><span class="count" id="others-count"></span></div>
<div id="others-list"></div>
</div>
<div class="col">
<div class="col-header"><h2>üö´ Blocked</h2><span class="count" id="blocked-count"></span></div>
<div id="blocked-list"></div>
</div>
</div>
</div>

<!-- COMPLETED TAB -->
<div class="tab-content" id="tab-completed">
<div class="grid grid-2" style="max-width:900px;">
<div class="col">
<div class="col-header"><h2>‚úÖ Done Today</h2><span class="count" id="done-count"></span></div>
<div id="done-list"></div>
</div>
<div class="col">
<div class="col-header"><h2>üí¨ Answered / Sent</h2><span class="count" id="answered-count"></span></div>
<div id="answered-list"></div>
</div>
</div>
</div>

<!-- OPEN ISSUES TAB -->
<div class="tab-content" id="tab-issues">
<div class="grid grid-2" style="max-width:900px;">
<div class="col" style="grid-column: 1 / -1;">
<div class="col-header"><h2>üîì Open Issues</h2><span class="count" id="issues-count"></span></div>
<p style="font-size:11px; color:#484f58; margin-bottom:14px;">Open-ended questions, unresolved debates, and things you haven't reached a conclusion on yet. Not tasks ‚Äî just threads to pick back up.</p>
<div id="issues-list"></div>
</div>
</div>
</div>

<!-- IDEAS TAB -->
<div class="tab-content" id="tab-ideas">
<div class="grid grid-2" style="max-width:900px;">
<div class="col" style="grid-column: 1 / -1;">
<div class="col-header"><h2>üí° Ideas Repository</h2><span class="count" id="ideas-count"></span></div>
<p style="font-size:11px; color:#484f58; margin-bottom:14px;">Rolling log of everything you've asked me to record. Also synced to Todoist #polmodel with <code style="background:#21262d;padding:1px 5px;border-radius:4px;">prism-idea</code> label.</p>
<div id="ideas-list"></div>
</div>
</div>
</div>

<!-- BACKLOG TAB -->
<div class="tab-content" id="tab-backlog">
<div class="grid grid-2" style="max-width:900px;">
<div class="col" style="grid-column: 1 / -1;">
<div class="col-header"><h2>üìã Backlog</h2><span class="count" id="backlog-count"></span></div>
<p style="font-size:11px; color:#484f58; margin-bottom:14px;">Someday/maybe items. Networking, outreach, ideas to revisit. No urgency, no due dates ‚Äî just recorded so nothing falls through the cracks.</p>
<div id="backlog-list"></div>
</div>
</div>
</div>

<!-- CALENDAR TAB -->
<div class="tab-content" id="tab-calendar">
<div class="cal-container">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
<h2 style="font-size:15px;font-weight:600;color:#e6edf3;">üìÖ Upcoming Calendar</h2>
<span class="count" id="calendar-count" style="background:#30363d;color:#8b949e;font-size:11px;padding:2px 8px;border-radius:10px;"></span>
</div>
<div id="calendar-list"></div>
</div>
</div>

<!-- TRANSCRIPTS TAB -->
<div class="tab-content" id="tab-transcripts">
<div class="grid grid-2" style="max-width:900px;">
<div class="col" style="grid-column: 1 / -1;">
<div class="col-header"><h2>üìù Causal Bandits Transcripts</h2><span class="count" id="transcripts-count"></span></div>
<p style="font-size:11px; color:#484f58; margin-bottom:14px;">Full transcripts from the <a href="https://www.youtube.com/playlist?list=PLhKKv6iMja4p5FbJIgzTOE67E1M6c8lnB" target="_blank" style="color:#58a6ff;">Causal Bandits Podcast</a> by Alex Molak. Auto-generated from YouTube subtitles.</p>
<div id="transcripts-list"></div>
</div>
</div>
</div>

<p class="refresh-note">Data: dashboard-data.json + ideas-data.json + backlog-data.json + calendar-data.json + transcripts-data.json ¬∑ Matrices updates automatically</p>

<!-- MODAL OVERLAY -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal">
    <div class="modal-header">
      <div class="modal-title">
        <span id="modal-title-text"></span>
        <span class="file-type" id="modal-file-type"></span>
      </div>
      <button class="modal-close" id="modal-close" title="Close (Esc)">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const DATA_URL = './dashboard-data.json';
const PROJECT_ORDER = ['prism','polmodel','aaru','vim','china','serif','general'];

// URL mapping for content files ‚Äî built from dashboard data
const URL_MAP = {};

// ===== MODAL LOGIC =====
const overlay = document.getElementById('modal-overlay');
const modalBody = document.getElementById('modal-body');
const modalTitleText = document.getElementById('modal-title-text');
const modalFileType = document.getElementById('modal-file-type');

function openModal(url, title) {
  const ext = url.split('.').pop().toLowerCase();
  modalTitleText.textContent = title || url.split('/').pop();
  modalFileType.textContent = ext.toUpperCase();
  modalBody.innerHTML = '<div class="modal-loading">Loading content‚Ä¶</div>';
  overlay.classList.add('visible');
  document.body.style.overflow = 'hidden';

  if (ext === 'html') {
    // For HTML files, use an iframe
    modalBody.innerHTML = `<iframe src="${url}" style="min-height:700px;" onload="this.style.height = Math.max(600, this.contentDocument.body.scrollHeight + 40) + 'px'"></iframe>`;
  } else {
    // Markdown ‚Äî fetch and render
    fetch(url + '?t=' + Date.now())
      .then(res => {
        if (!res.ok) throw new Error('Failed to load');
        return res.text();
      })
      .then(md => {
        modalBody.innerHTML = '<div class="md-content">' + marked.parse(md) + '</div>';
      })
      .catch(err => {
        modalBody.innerHTML = '<div class="modal-error">‚ùå Could not load file: ' + err.message + '</div>';
      });
  }
}

function closeModal() {
  overlay.classList.remove('visible');
  document.body.style.overflow = '';
  modalBody.innerHTML = '';
}

document.getElementById('modal-close').addEventListener('click', closeModal);
overlay.addEventListener('click', function(e) {
  if (e.target === overlay) closeModal();
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && overlay.classList.contains('visible')) closeModal();
});

// ===== TAB SWITCHING =====
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ===== RENDERING =====

// Make desc text linkable when it references known content files
function linkifyDesc(desc) {
  if (!desc) return '';
  // Match patterns like drafts/filename.md or briefs/filename.md
  return desc.replace(/((?:drafts|briefs)\/[\w\-]+\.(?:md|html))/g, function(match) {
    const filename = match.split('/').pop();
    const url = URL_MAP[filename];
    if (url) {
      return '<span class="inline-link" onclick="event.stopPropagation(); openModal(\'' + url + '\', \'' + filename + '\')">' + match + '</span>';
    }
    return match;
  });
}

function renderCard(item, completed) {
  const badges = (item.badges || []).map(b =>
    `<span class="badge badge-${b.type}">${b.text}</span>`
  ).join('');
  const hasUrl = !!item.url;
  const clickClass = hasUrl ? 'clickable' : '';
  const clickAttr = hasUrl ? ` onclick="openModal('${item.url}', '${item.title.replace(/'/g, "\\'")}')"` : '';
  const viewIcon = hasUrl ? '<span class="view-icon">üìÑ View</span>' : '';
  const desc = linkifyDesc(item.desc || '');
  return `
    <div class="card ${completed ? 'completed-card' : ''} ${clickClass}"${clickAttr}>
      <div class="card-title">${viewIcon}${item.title}${badges}</div>
      <div class="card-desc">${desc}</div>
      ${item.meta ? `<div class="card-meta">${item.meta}</div>` : ''}
    </div>
  `;
}

function renderGrouped(items, projects, completed) {
  if (!items.length) return '<div class="empty">Nothing here</div>';
  const projMap = {};
  projects.forEach(p => projMap[p.id] = p);
  const groups = {};
  items.forEach(item => {
    const pid = item.project || 'general';
    if (!groups[pid]) groups[pid] = [];
    groups[pid].push(item);
  });
  let html = '';
  PROJECT_ORDER.forEach(pid => {
    if (!groups[pid] || !groups[pid].length) return;
    const proj = projMap[pid] || { name: pid, emoji: 'üìã', color: '#8b949e' };
    html += `<div class="project-group">
      <div class="project-divider">
        <span class="project-dot" style="background:${proj.color}"></span>
        <span class="project-name" style="color:${proj.color}">${proj.emoji} ${proj.name}</span>
      </div>
      ${groups[pid].map(i => renderCard(i, completed)).join('')}
    </div>`;
  });
  return html;
}

function setCount(id, n) { document.getElementById(id).textContent = n; }

function buildUrlMap(data) {
  // Scan all sections for items with url fields
  const sections = ['files','tasks','upcoming','waiting','blocked','done','answered'];
  sections.forEach(s => {
    (data[s] || []).forEach(item => {
      if (item.url) {
        const filename = item.url.split('/').pop();
        URL_MAP[filename] = item.url;
      }
    });
  });
}

function render(data) {
  document.getElementById('timestamp').textContent = new Date().toLocaleString('en-US', {
    timeZone: 'America/New_York', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true
  });
  const p = data.projects || [];

  // Build URL map for inline links
  buildUrlMap(data);

  // Active tab
  setCount('files-count', data.files.length);
  setCount('tasks-count', data.tasks.length);
  setCount('upcoming-count', data.upcoming.length);
  document.getElementById('files-list').innerHTML = renderGrouped(data.files, p);
  document.getElementById('tasks-list').innerHTML = renderGrouped(data.tasks, p);
  document.getElementById('upcoming-list').innerHTML = renderGrouped(data.upcoming, p);

  // Waiting tab
  setCount('others-count', data.waiting.length);
  setCount('blocked-count', data.blocked.length);
  document.getElementById('others-list').innerHTML = renderGrouped(data.waiting, p);
  document.getElementById('blocked-list').innerHTML = renderGrouped(data.blocked, p);

  // Completed tab
  setCount('done-count', data.done.length);
  setCount('answered-count', data.answered.length);
  document.getElementById('done-list').innerHTML = renderGrouped(data.done, p, true);
  document.getElementById('answered-list').innerHTML = renderGrouped(data.answered, p, true);

  // Tab counts
  const activeTotal = data.files.length + data.tasks.length + data.upcoming.length;
  const waitingTotal = data.waiting.length + data.blocked.length;
  const completedTotal = data.done.length + data.answered.length;
  setCount('active-total', activeTotal);
  setCount('waiting-total', waitingTotal);
  setCount('completed-total', completedTotal);
}

async function loadIssues() {
  try {
    const res = await fetch('./issues-data.json?t=' + Date.now());
    const issues = await res.json();
    setCount('issues-total', issues.length);
    setCount('issues-count', issues.length);
    if (!issues.length) {
      document.getElementById('issues-list').innerHTML = '<div class="empty">No open issues</div>';
      return;
    }
    const projMap = {};
    (await (await fetch(DATA_URL + '?t=' + Date.now())).json()).projects.forEach(p => projMap[p.id] = p);

    const groups = {};
    issues.forEach(issue => {
      const pid = issue.project || 'general';
      if (!groups[pid]) groups[pid] = [];
      groups[pid].push(issue);
    });

    let html = '';
    PROJECT_ORDER.forEach(pid => {
      if (!groups[pid] || !groups[pid].length) return;
      const proj = projMap[pid] || { name: pid, emoji: 'üìã', color: '#8b949e' };
      html += `<div class="project-group">
        <div class="project-divider">
          <span class="project-dot" style="background:${proj.color}"></span>
          <span class="project-name" style="color:${proj.color}">${proj.emoji} ${proj.name}</span>
        </div>
        ${groups[pid].map(issue => `
          <div class="card" style="border-left:3px solid #d29922;">
            <div class="card-title">${issue.title}</div>
            <div class="card-desc">${issue.desc}</div>
            <div class="card-meta" style="display:flex;gap:8px;align-items:center;">
              <span>${issue.date}</span>
              ${(issue.tags||[]).map(t => '<span class="badge badge-waiting">'+t+'</span>').join('')}
            </div>
          </div>
        `).join('')}
      </div>`;
    });
    document.getElementById('issues-list').innerHTML = html;
  } catch(e) {}
}

async function loadIdeas() {
  try {
    const res = await fetch('./ideas-data.json?t=' + Date.now());
    const ideas = await res.json();
    setCount('ideas-total', ideas.length);
    setCount('ideas-count', ideas.length);
    if (!ideas.length) {
      document.getElementById('ideas-list').innerHTML = '<div class="empty">No ideas yet</div>';
      return;
    }
    document.getElementById('ideas-list').innerHTML = ideas.map((idea, i) => `
      <div class="card" style="border-left:3px solid #d2a8ff;">
        <div class="card-title" style="display:flex;justify-content:space-between;">
          <span>${idea.title}</span>
          <span style="font-size:10px;color:#484f58;background:#21262d;padding:2px 8px;border-radius:6px;font-weight:600;">#${ideas.length - i}</span>
        </div>
        <div class="card-desc">${idea.desc}</div>
        <div class="card-meta" style="display:flex;gap:8px;align-items:center;">
          <span>${idea.date}</span>
          ${(idea.tags||[]).map(t => '<span class="badge badge-brief">'+t+'</span>').join('')}
        </div>
      </div>
    `).join('');
  } catch(e) {}
}

async function loadBacklog() {
  try {
    const res = await fetch('./backlog-data.json?t=' + Date.now());
    const items = await res.json();
    setCount('backlog-total', items.length);
    setCount('backlog-count', items.length);
    if (!items.length) {
      document.getElementById('backlog-list').innerHTML = '<div class="empty">Nothing in backlog</div>';
      return;
    }
    // Get projects for grouping
    const projRes = await fetch(DATA_URL + '?t=' + Date.now());
    const projData = await projRes.json();
    const projMap = {};
    projData.projects.forEach(p => projMap[p.id] = p);

    const groups = {};
    items.forEach(item => {
      const pid = item.project || 'general';
      if (!groups[pid]) groups[pid] = [];
      groups[pid].push(item);
    });

    let html = '';
    PROJECT_ORDER.forEach(pid => {
      if (!groups[pid] || !groups[pid].length) return;
      const proj = projMap[pid] || { name: pid, emoji: 'üìã', color: '#8b949e' };
      html += '<div class="project-group">';
      html += '<div class="project-divider">';
      html += '<span class="project-dot" style="background:' + proj.color + '"></span>';
      html += '<span class="project-name" style="color:' + proj.color + '">' + proj.emoji + ' ' + proj.name + '</span>';
      html += '</div>';
      groups[pid].forEach(item => {
        const tags = (item.tags || []).map(t => '<span class="backlog-tag">' + t + '</span>').join('');
        html += '<div class="card">';
        html += '<div class="card-title">' + item.title + '</div>';
        html += '<div class="card-desc">' + (item.desc || '') + '</div>';
        if (tags) html += '<div style="margin-top:4px;">' + tags + '</div>';
        html += '</div>';
      });
      html += '</div>';
    });
    document.getElementById('backlog-list').innerHTML = html;
  } catch(e) { console.error('Backlog load failed:', e); }
}

async function loadCalendar() {
  try {
    const res = await fetch('./calendar-data.json?t=' + Date.now());
    const weeks = await res.json();
    // Get projects for dot colors
    const projRes = await fetch(DATA_URL + '?t=' + Date.now());
    const projData = await projRes.json();
    const projMap = {};
    projData.projects.forEach(p => projMap[p.id] = p);

    let totalEntries = 0;
    weeks.forEach(w => totalEntries += w.entries.length);
    setCount('calendar-total', totalEntries);
    setCount('calendar-count', totalEntries + ' events');

    if (!weeks.length) {
      document.getElementById('calendar-list').innerHTML = '<div class="empty">No upcoming dates</div>';
      return;
    }

    let html = '';
    weeks.forEach(week => {
      html += '<div class="cal-week">';
      html += '<div class="cal-week-header">üìÜ ' + week.week + '</div>';
      week.entries.forEach(entry => {
        const proj = projMap[entry.project] || { color: '#8b949e' };
        const spanClass = entry.span ? ' span-entry' : '';
        html += '<div class="cal-entry' + spanClass + '">';
        html += '<span class="cal-dot" style="background:' + proj.color + '"></span>';
        html += '<span class="cal-date-col">' + entry.date + '</span>';
        html += '<span class="cal-day-col">' + (entry.day || '') + '</span>';
        html += '<span class="cal-time-col">' + (entry.time || '') + '</span>';
        html += '<span class="cal-title-col">' + entry.title + '</span>';
        html += '</div>';
      });
      html += '</div>';
    });
    document.getElementById('calendar-list').innerHTML = html;
  } catch(e) { console.error('Calendar load failed:', e); }
}

async function loadToday() {
  try {
    const res = await fetch('./today-data.json?t=' + Date.now());
    const data = await res.json();
    // Get projects for colors
    const projRes = await fetch(DATA_URL + '?t=' + Date.now());
    const projData = await projRes.json();
    const projMap = {};
    projData.projects.forEach(p => projMap[p.id] = p);

    document.getElementById('today-date-display').textContent = data.greeting || data.date;

    const pending = data.items.filter(i => !i.done);
    const done = data.items.filter(i => i.done);

    if (!pending.length) {
      document.getElementById('today-list').innerHTML = '<div class="empty">All done for today üéâ</div>';
    } else {
      document.getElementById('today-list').innerHTML = pending.map(item => {
        const proj = projMap[item.project] || { color: '#8b949e', emoji: 'üìã' };
        const priorityBorder = item.priority === 'high' ? 'border-left:3px solid #f85149;' : 'border-left:3px solid ' + proj.color + ';';
        const priorityBadge = item.priority === 'high' ? '<span class="badge badge-urgent">PRIORITY</span>' : '';
        const isInternal = item.url && !item.url.startsWith('http');
        const isExternal = item.url && item.url.startsWith('http');
        const clickClass = item.url ? 'clickable' : '';
        const clickAttr = isInternal ? ` onclick="openModal('${item.url}', '${(item.title||'').replace(/'/g, "\\'")}')"` : (isExternal ? ` onclick="window.open('${item.url}','_blank')"` : '');
        const viewIcon = item.url ? '<span class="view-icon">üìÑ</span>' : '';
        return `<div class="card ${clickClass}" style="${priorityBorder}"${clickAttr}>
          <div class="card-title" style="display:flex;align-items:center;gap:6px;">
            <span class="project-dot" style="background:${proj.color};width:6px;height:6px;"></span>
            ${item.title}${priorityBadge}${viewIcon}
          </div>
          <div class="card-desc">${item.desc || ''}</div>
        </div>`;
      }).join('');
    }

    if (!done.length) {
      document.getElementById('today-done-section').style.display = 'none';
    } else {
      document.getElementById('today-done-section').style.display = 'block';
      document.getElementById('today-done-list').innerHTML = done.map(item => {
        const proj = projMap[item.project] || { color: '#8b949e' };
        const linkHtml = item.url ? `<a href="${item.url}" target="_blank" style="color:#58a6ff;font-size:11px;text-decoration:none;">üîó Open ‚Üí</a>` : '';
        return `<div class="card completed-card" style="border-left:3px solid ${proj.color};">
          <div class="card-title" style="display:flex;align-items:center;gap:6px;">
            <span style="color:#3fb950;">‚úì</span> ${item.title}
          </div>
          <div class="card-desc">${item.desc || ''}</div>
          ${linkHtml}
        </div>`;
      }).join('');
    }
  } catch(e) { console.error('Today load failed:', e); }
}

async function loadTranscripts() {
  try {
    const res = await fetch('./transcripts-data.json?t=' + Date.now());
    const episodes = await res.json();
    setCount('transcripts-total', episodes.length);
    setCount('transcripts-count', episodes.length + ' episodes');
    if (!episodes.length) {
      document.getElementById('transcripts-list').innerHTML = '<div class="empty">No transcripts</div>';
      return;
    }

    const seasonOrder = ['S2', 'S1', 'Conference'];
    const seasonLabels = { 'S2': 'üéôÔ∏è Season 2', 'S1': 'üéôÔ∏è Season 1', 'Conference': 'üé§ Conference Coverage' };
    const seasonColors = { 'S2': '#58a6ff', 'S1': '#3fb950', 'Conference': '#d29922' };

    const groups = {};
    episodes.forEach(ep => {
      const s = ep.season;
      if (!groups[s]) groups[s] = [];
      groups[s].push(ep);
    });

    let html = '';
    seasonOrder.forEach(s => {
      if (!groups[s] || !groups[s].length) return;
      const color = seasonColors[s] || '#8b949e';
      html += '<div class="project-group">';
      html += '<div class="project-divider">';
      html += '<span class="project-dot" style="background:' + color + '"></span>';
      html += '<span class="project-name" style="color:' + color + '">' + (seasonLabels[s] || s) + ' (' + groups[s].length + ')</span>';
      html += '</div>';
      groups[s].forEach(ep => {
        const epLabel = ep.episode !== null ? (s === 'S2' ? 'S2E' + ep.episode : 'Ep ' + ep.episode) : (s === 'Conference' ? '' : 'Extra');
        const epBadge = epLabel ? '<span style="font-size:10px;color:#484f58;background:#21262d;padding:2px 8px;border-radius:6px;font-weight:600;margin-right:6px;">' + epLabel + '</span>' : '';
        html += '<div class="card clickable" onclick="openModal(\'' + ep.file + '\', \'' + ep.title.replace(/'/g, "\\'") + '\')">';
        html += '<div class="card-title"><span class="view-icon">üìÑ View</span>' + epBadge + ep.title + '</div>';
        html += '<div class="card-desc">' + ep.guest + ' ¬∑ <a href="' + ep.youtube + '" target="_blank" onclick="event.stopPropagation();" style="color:#58a6ff;text-decoration:none;">‚ñ∂ YouTube</a></div>';
        html += '</div>';
      });
      html += '</div>';
    });
    document.getElementById('transcripts-list').innerHTML = html;
  } catch(e) { console.error('Transcripts load failed:', e); }
}

async function load() {
  try {
    const res = await fetch(DATA_URL + '?t=' + Date.now());
    render(await res.json());
  } catch(e) { console.error('Load failed:', e); }
  loadToday();
  loadIdeas();
  loadIssues();
  loadBacklog();
  loadCalendar();
  loadTranscripts();
}
load();
setInterval(load, 30000);
</script>
</body>
</html>
